name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install backend dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install email-validator 
    
    - name: Run backend tests
      run: |
        cd backend
        
        # Install email-validator FIRST
        pip install email-validator
        # THEN import
        python -c "from main import app; print('‚úÖ Backend imports successfully')"
        python -c "from main import app; print('‚úÖ Backend imports successfully')"
        python -c "import hashlib; print('‚úÖ Hashlib works')"
        python -c "import fastapi; print(f'‚úÖ FastAPI version: {fastapi.__version__}')"
    
    - name: Security scan
      run: |
        cd backend
        pip install bandit
        bandit -r . -f json -o bandit-results.json || true

  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install frontend dependencies
      run: |
        cd frontend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Check frontend imports
      run: |
        cd frontend
        python -c "import streamlit; print(f'‚úÖ Streamlit version: {streamlit.__version__}')"
        python -c "import requests; print('‚úÖ Requests imported')"
        python -c "import pandas as pd; print('‚úÖ Pandas imported')"

  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Backend Docker image
      run: |
        cd backend
        docker build -t payment-backend:latest .
    
    - name: Build Frontend Docker image
      run: |
        cd frontend
        docker build -t payment-frontend:latest .
    
    - name: Verify Docker images
      run: |
        docker images | grep payment

  deploy-notify:
    name: Deployment Status
    runs-on: ubuntu-latest
    needs: build-docker
    if: always()
    
    steps:
    - name: Deployment Simulation
      run: |
        echo "üöÄ Deployment would happen here"
        echo "Backend ready for: Heroku/Render/AWS"
        echo "Frontend ready for: Streamlit Cloud/Vercel"
        echo "‚úÖ All checks passed!"
    
    - name: Send success notification
      if: success()
      run: |
        echo "‚úÖ Pipeline completed successfully!"
        echo "View at: https://github.com/${{ github.repository }}/actions"
    
    - name: Send failure notification
      if: failure()
      run: |
        echo "‚ùå Pipeline failed!"
        echo "Check logs at: https://github.com/${{ github.repository }}/actions"